#######################
# GitLab Environments #
#######################

Types of environments (Типы окружений)
(https://docs.gitlab.com/ee/ci/environments/#types-of-environments)

Существует 2 типа окружений:
  • статические
  • динамические

Статическое окружение
  - Обычно повторно используется при последующих развертываниях.
  - Имеет статическое имя, например, staging или production.
  - Создается вручную или как часть конвейера CI/CD.

Динамическое окружение
  - Обычно создается в конвейере CI/CD и используется только для одного развертывания, а затем либо останавливается, либо удаляется.
  - Имеет динамическое имя, обычно основанное на значении переменной CI/CD.
  - Особенность обзорных приложений (https://docs.gitlab.com/ee/ci/review_apps/index.html)

Создание статисеского окружения
  Можно создать
    • в UI
	  - нужно иметь по меньшей мере роль Developer
	  Шаги создания статического окружения с помощью UI:
	    1. На левой боковой панели вверху выбрать Search GitLab (), чтобы найти свой проект
		2. Выбрать Operate (Операция) > Environments (Среды)
		3. Выбрать Create an environment (Создать среду)
		4. Заполнить поля
		5. Выбрать "Сохранить"
		
    • в файле .gitlab-ci.yml
      - нужно иметь по меньшей мере роль Developer
	  Шаги создания статического окружения:
	    1. Задать job внутри этапа (stage) deploy
		2. Внутри джобы задать ИМЯ и URL окружения.
		   Если на момент запуска конвейера среда с таким именем не существует, она будет создана.

‼ Некоторые символы нельзя использовать в именах окружений.
  Дополнительные сведения о ключевых словах окружения см. в справочнике ключевых слов .gitlab-ci.yml.
  (https://docs.gitlab.com/ee/ci/yaml/index.html#environment)

{ Какие символы использовать МОЖНО:
  1. Обычный текст, включая буквы, цифры, пробелы и эти символы: -, _, /, $, {, }.
  2. Переменные CI/CD, включая предопределенные переменные, переменные проекта, группы, экземпляра или переменные, определенные в файле .gitlab-ci.yml. 
}
‼! Вы не можете использовать переменные, определенные в разделе сценария.

Пример: создадим окружение (среду) с именем staging и URL https://staging.example.com

deploy_staging:
  stage: deploy
  script:
    - echo "Deploy to staging server"
  environment:
    name: staging
    url: https://staging.example.com


Создание динамических окружений

  Для создания динамического окружения используются переменные CI/CD, уникальные для каждого пайплайна.

  Предварительные условия:
      Роль как минимум Developer.

  Чтобы создать динамическое окружение, в файле .gitlab-ci.yml:
    1. Определить задание (job) на этапе развертывания (stage: deploy).
    2. В задании определите следующие атрибуты среды:
        name: Используйте связанную CI/CD переменную, например $CI_COMMIT_REF_SLUG.
		(По желанию добавьте к имени окружения статический префикс,
		который группирует в пользовательском интерфейсе все окружения с таким же префиксом.)
        url: Необязательно. Префикс имени хоста со связанной CI/CD переменной, например $CI_ENVIRONMENT_SLUG.

В следующем примере при каждом запуске задания deploy_review_app имя среды и URL определяются с помощью уникальных значений.

deploy_review_app:
  stage: deploy
  script: make deploy
  environment:
    name: review/$CI_COMMIT_REF_SLUG				# review - статический префикс
    url: https://$CI_ENVIRONMENT_SLUG.example.com
  only:
    - branches
  except:
    - main


Откат среды (Environment rollback)

При откате развертывания на определенном коммите создается новое развертывание.
Это развертывание имеет свой уникальный идентификатор задания.
Он указывает на коммит, к которому вы откатываетесь.

Чтобы rollback прошел успешно, процесс развертывания должен быть определен в сценарии задания.

Повторная попытка или откат развертывания
  Если с развертыванием возникли проблемы, его можно повторить или откатить.
  Чтобы повторить или откатить развертывание, выполните следующие действия:

    1. На левой боковой панели вверху выберите Поиск GitLab (), чтобы найти свой проект.
    2. Выберите Операция > Среды.
    3. Выберите среду.
    4. Справа от имени развертывания:
      • Чтобы повторить развертывание, выберите "Re-deploy to environment"
      • Чтобы откатиться к развертыванию, рядом с ранее успешным развертыванием выберите "Rollback environment" (Откатить среду)